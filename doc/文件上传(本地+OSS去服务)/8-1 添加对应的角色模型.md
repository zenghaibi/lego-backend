#### 1.在用户模型中添加角色字段：

```typescript
export interface UserProps {
  username: string;
  password: string;
  email?: string;
  nickName?: string;
  picture?: string;
  phoneNumber?: string;
  createdAt: Date;
  updatedAt: Date;
  type: 'email' | 'cellphone' | 'oauth';
  provider?: 'gitee';
  oauthID?: string;
  // 添加角色字段，类型是字面量，可根据需进行扩展
  role?: 'admin' | 'normal';
}

function initUserModel(app: Application) {
  const AutoIncrement = AutoIncrementFactory(app.mongoose);
  const userSchema = new Schema<UserProps>(
    {
      username: { type: String, unique: true, required: true },
      password: { type: String },
      email: { type: String },
      nickName: { type: String },
      picture: { type: String },
      phoneNumber: { type: String },
      type: { type: String, default: 'email' },
      provider: { type: String },
      oauthID: { type: String },
      // 默认角色是normal 普通用户
      role: { type: String, default: 'normal' },
    },
```

#### 定义角色权限规则：

```typescript
import { AbilityBuilder, createMongoAbility } from '@casl/ability';
import { Document } from 'mongoose';
import { UserProps } from '../model/user';

export default function defineRoles(
  user: UserProps & Document<any, any, UserProps>
) {
  const { can, build } = new AbilityBuilder(createMongoAbility);
  if (user) {
    // 管理员拥有全部权限
    if (user.role === 'admin') {
      can('manage', 'all');
    } else {
      // normal login user
      // users, 只能读取自己的信息，以及更新特的字段
      can('read', 'User', {_id: user._id});
      can('update', 'User', ['nickName', 'picture'], { _id: user._id });
      // works, 可以创建， 然后可以更新和删除自己的 Work
      can('create', 'Work', ['title', 'desc', 'content', 'coverImg']);
      can('read', 'Work', { user: user._id });
      can('update', 'Work', ['title', 'desc', 'content', 'coverImg'], {
        user: user._id,
      });
      can('delete', 'Work', { user: user._id });
      // channels, 创建, 更新和删除属于自己的 channel
      can('create', 'Channel', ['name', 'workId'], { user: user._id });
      can('read', 'Channel', { user: user._id });
      can('update', 'Channel', ['name'], { user: user._id });
      can('delete', 'Channel', ['name'], { user: user._id });
    }
  }
  return build();
}
```
