# 更新文档中的数组

```
    const updateFilter: UpdateFilter<{
      name: string;
      age: number;
      hobbies: string[];
    }> = {
      // $push: {
      //   hobbies: 'busketball',
      // },
      // $push: {
      //   hobbies: {$each: ['打麻将','爬山','滑雪']},
      // },
      // $push: {
      //   hobbies: {$each: ['第一项做菜'], $position: 0},
      // },
      // $pop: {
      //   hobbies: 1 , // 表示从数据中删最后一项
      // }
      // $pop: {
      //   hobbies: -1 , // 表示从数据中删第一项
      // }
      // $pull: {
      //   hobbies: 'busketball', //表示指定删除某一项
      // }
      $set: {
        "hobbies.0": 'KTV', // 修改中指定下标某一项的值
      }
    };
```

## 概述

在本指南中，您可以了解如何使用以下数组更新运算符来修改嵌入在文档中的数组：

* [位置运算符](https://www.mongodb.com/docs/drivers/node/current/fundamentals/crud/write-operations/embedded-arrays/#std-label-first-match-operator)：`$`
* [所有位置运算符](https://www.mongodb.com/docs/drivers/node/current/fundamentals/crud/write-operations/embedded-arrays/#std-label-all-match-operator)：`$[]`
* [过滤位置运算符](https://www.mongodb.com/docs/drivers/node/current/fundamentals/crud/write-operations/embedded-arrays/#std-label-filtered-positional-operator)：`$[<identifier>]`

请参阅 MongoDB 服务器指南 [更新运算符](https://www.mongodb.com/docs/manual/reference/operator/update-array/#update-operators) 完整列表。



### 样本文件

本指南中的示例使用 `test.pizza`集合中的以下示例文档。该集合包含将客户及其披萨订单描述为名为 的字段中的数组元素的文档 `items`。

```
[{   name: "Steve Lobsters",   address: "731 Yexington Avenue",   items: [     { type: "beverage", name: "Water", size: "17oz", },     { type: "pizza", size: "large", toppings: ["pepperoni"], },     { type: "pizza", size: "medium", toppings: ["mushrooms", "sausage", "green peppers"], comment: "Extra green peppers please!", },     { type: "pizza", size: "large", toppings: ["pineapple, ham"], comment: "red pepper flakes on top", },     { type: "calzone", fillings: ["canadian bacon", "sausage", "onion"], },     { type: "beverage", name: "Diet Pepsi", size: "16oz", },   ], }, {   name: "Popeye",   address: "1 Sweethaven",   items: [     { type: "pizza", size: "large", toppings: ["garlic, spinach"], },     { type: "calzone", toppings: ["ham"], },   ], }]
```

## 指定数组元素

您可以使用位置运算符指定要更新的数组元素。位置运算符可以指定要更新的第一个、所有或某些数组元素。

要使用位置运算符指定数组中的元素，请使用 **点表示法** 。点表示法是一种用于导航 BSON 对象的属性访问语法。要了解更多信息，请参阅[点符号。](https://www.mongodb.com/docs/manual/core/document/#std-label-document-dot-notation)

### 第一个匹配的数组元素

要更新与查询匹配的每个文档的第一个数组元素，请使用位置运算符 `$`。

位置运算符 `$`引用查询匹配的数组。您不能使用此运算符来引用嵌套数组。对于要访问嵌套数组的情况，请使用 [过滤位置运算符。](https://www.mongodb.com/docs/drivers/node/current/fundamentals/crud/write-operations/embedded-arrays/#std-label-filtered-positional-operator)

## 重要的

不要 `$`在调用中使用运算符，`upsert`因为驱动程序将 `$`其视为插入文档中的字段名称。

#### 例子

以下代码片段显示了如何将名为 Steve Lobster 的客户的第一个披萨订单商品的大小更新为“超大”。

```
    const query = { name: "Steve Lobsters", "items.type": "pizza" };    const updateDocument = {      $set: { "items.$.size": "extra large" }    };    const result = await pizza.updateOne(query, updateDocument);
```

该查询匹配包含嵌入在 `items`数组中的元素的所有文档，该元素包含字段 `pizza`中的值 `type`。指定更新操作以将第 `updateDocument`一个数组元素匹配设置 `items`为“特大”。

运行更新方法后，Steve Lobster 的客户文档类似于以下内容：

```
{  name: "Steve Lobsters",  address: "731 Yexington Avenue",  items: [    { type: "pizza", size: "extra large", ... },    ...  ]}
```

请注意，我们在查询中同时包含 `name`和 `items.type`字段，以匹配我们应用 `$`运算符的数组。如果我们 `items.type`在查询中省略该字段并 `$`在更新中指定运算符，则会遇到以下错误：

```
The positional operator did not find the match needed from the query.
```

### 匹配所有数组元素

要对与查询匹配的每个文档的所有数组元素执行更新，请使用 all 位置运算符 `$[]`。

#### 例子

以下代码片段将“新鲜马苏里拉奶酪”添加到 Popeye 的所有订单项目的配料中。

```
    const query = { "name": "Popeye" };    const updateDocument = {      $push: { "items.$[].toppings": "fresh mozzarella" }    };    const result = await pizza.updateOne(query, updateDocument);
```

运行更新方法后，您的 Popeye 客户文档类似于以下内容：

```
{  name:"Popeye",  address: "1 Sweethaven",  items: [    { type: "pizza", ... , toppings: ["garlic", "spinach", "fresh mozzarella"], },    { type: "calzone", ... , toppings: ["ham", "fresh mozzarella"], },  ]}
```

### 匹配多个数组元素

要对与您的查询匹配的每个文档的所有嵌入数组元素执行更新，请使用过滤的位置运算符 `$[<identifier>]`。

过滤的位置运算符 `$[<identifier>]`指定更新文档中的匹配数组元素。`<identifier>`要识别要匹配的数组元素，请将此运算符与 `options.arrayFilters`对象配对。

该 `<identifier>`术语是您分配的占位符值，它表示作为前缀的数组字段名称的元素。此值必须以小写字母开头并且仅包含字母数字字符。

#### 例子

要为某些订单项目添加“大蒜”浇头，请按如下格式设置更新文档：

```
{ $push: { items.$[orderItem].toppings: "garlic" } }
```

此更新文档指定以下内容：

* `$push`: 更新操作符
* `items`: 文档中要更新的数组
* `orderItem`：过滤后的位置运算符的标识符
* `toppings``items`：要更新的数组元素上的字段
* `garlic`: 推入 `toppings`数组的值

接下来，`arrayFilters`在更新操作的 `options`参数中添加对象中的匹配条件。此对象是一个查询数组，用于指定要在更新中包含哪些数组元素。要将“大蒜”浇头添加到“披萨”和“大尺寸”类型的订单项目中，请传递以下内容 `arrayFilters`：

```
arrayFilters: [  { orderItem.type: "pizza" },  { orderItem.size: "large" }]
```

以下片段显示了完整的更新方法：

```
    const query = { name: "Steve Lobsters" };    const updateDocument = {      $push: { "items.$[orderItem].toppings": "garlic" }    };    const options = {      arrayFilters: [{        "orderItem.type": "pizza",        "orderItem.size": "large",      }]    };    const result = await pizza.updateMany(query, updateDocument, options);
```

运行该方法后，Steve Lobster 的客户文档类似于以下内容：

```
{  name: "Steve Lobsters",  address: "731 Yexington Avenue",  items: [    { type: "pizza", size: "large", toppings: ["pepperoni", "garlic"] },    { type: "pizza", size: "large", toppings: ["pineapple", "ham", "garlic"], ...},    ...  ]}
```

#### 例子

假设 Steve Lobster 想要调整他们的订单，在所有有意大利辣香肠的比萨饼中添加“意大利腊肠”作为配料。要执行更新，请使用过滤后的位置运算符，如下所示：

```
    const query = { name: "Steve Lobsters" };    const updateDocument = {      $push: { "items.$[item].toppings": "salami" },    };    const options = {      arrayFilters: [        {          "item.type": "pizza",          "item.toppings": "pepperoni",        },      ],    };    const result = await pizza.updateOne(query, updateDocument, options);
```

运行更新方法后，Steve Lobster 的客户文档类似于以下内容：

```
{  name: "Steve Lobsters",  address: "731 Yexington Avenue",  items: [    { type: "pizza", size: "large", toppings: ["pepperoni", "salami"], },    { type: "pizza", size: "medium", toppings: ["mushrooms", "sausage", "green peppers"], comment: "Extra green peppers please!", },    { type: "pizza", size: "large", toppings: ["pineapple, ham"], comment: "red pepper flakes on top", },    { type: "calzone", fillings: ["canadian bacon", "sausage", "onion"], },    { type: "beverage", name: "Diet Pepsi", size: "16oz", },  ],}
```
